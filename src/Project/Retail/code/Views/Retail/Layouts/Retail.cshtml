@using System.Globalization
@using Coveo.UI.Components.Extensions
@using Sitecore.Commerce.Connect.CommerceServer
@using Sitecore.Foundation.Assets.Models
@using Sitecore.Foundation.Assets.Services
@using Sitecore.Mvc.Analytics.Extensions
@using Sitecore.Foundation.Commerce.Managers
@using Sitecore.Foundation.Commerce.Models
@using Sitecore.Commerce.Connect.CommerceServer.Orders.Models
@using Sitecore.ExperienceExplorer.Business.Utilities.Extensions
@using Sitecore.Feature.Commerce.Catalog.Factories
@using Sitecore.Foundation.Commerce.Repositories
@using Sitecore.Mvc.Presentation
@inherits WebViewPage
@{
    Layout = null;
}
<!DOCTYPE html>
<!--[if IE 9]><html lang="en" class="ie9 no-js"><![endif]-->
<!--[if !IE]><!-->
<html lang="@Sitecore.Context.Language.CultureInfo.TwoLetterISOLanguageName">
<!--<![endif]-->
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    @MetadataManager.GetTags()
    @{
        var catalogItemContext = DependencyResolver.Current.GetService<CatalogItemContext>();
        bool isProduct = catalogItemContext.IsProduct;
        var productItem = catalogItemContext.Current?.Item;
        if (isProduct && productItem != null) {
            var brandField = productItem.Fields["Brand"];
            if (brandField != null && brandField.HasValue) {
                @:<meta name="productBrandName" content="@productItem.Fields["Brand"].Value" />
            }
            var productViewModelFactory = DependencyResolver.Current.GetService<ProductViewModelFactory>();
            var productViewModel = productViewModelFactory.Create(RenderingContext.Current.Rendering.Item);
            if (productViewModel != null && productViewModel.AdjustedPrice.HasValue) {
                @:<meta name="productListPrice" content="@productViewModel.AdjustedPrice.Value.ToString("F2", CultureInfo.InvariantCulture)" />
            }
        }
    }

    @if (!Sitecore.Context.PageMode.IsExperienceEditor)
    {
        @Html.Sitecore().Placeholder("head")
    }

    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.3/js.cookie.js"></script>

    @RenderAssetsService.Current.RenderScript(ScriptLocation.Head)
    @RenderAssetsService.Current.RenderStyles()

    <link href="/styles/CoveoCommerce/CoveoCommerce.css" rel="stylesheet" />

    @Html.Sitecore().VisitorIdentification()

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body class="@(Sitecore.Context.PageMode.IsExperienceEditor ? "header-static" : "") @(Sitecore.Context.PageMode.IsNormal ? "" : (Sitecore.Context.PageMode.IsExperienceEditor ? "pagemode-edit" : "pagemode-preview"))">
    <script type="text/javascript">
        var currentCategory;

        @{
            var context = DependencyResolver.Current.GetService<CatalogItemContext>();
            bool isCategory = context.IsCategory;
            var catalogItem = context.Current?.Item;
            if (isCategory && catalogItem != null)
            {
                @:currentCategory = "@catalogItem.ID.ToString()";
            }
        }
    </script>

    <form id="_CRSFform" action="#" method="post">
        @Html.AntiForgeryToken()
    </form>

    <div id="main-container">
        <!-- BEGIN NOINDEX -->
        <header class="bg-white @(Sitecore.Context.PageMode.IsExperienceEditor ? "header-static" : "header-fixed") header-has-top">
            @Html.Sitecore().Placeholder("header-top")

            @Html.Sitecore().Placeholder("navbar")

            <div class="container" style="padding-bottom: 13px;">
                <!-- Retail Search Resources -->
                @Html.Sitecore().Rendering("{41C7C6DD-C132-44BD-890A-B035056BC054}", new { DataSource = "{935D727D-DCFF-47C5-9651-3114F8CE5785}" })
                <!--Retail User Context-->
                @Html.Sitecore().Rendering("{8231CD1A-3377-4FE8-A27C-F6382ACB8C52}", new { DataSource = "{EC7579BE-06AB-4921-9A87-CEF548A93343}" })
                <!-- Retail Page View Analytics -->
                @Html.Sitecore().Rendering("{427B5381-A9C5-47C8-AF8F-867852F8F460}", new { DataSource = "{39F1386F-33C9-473D-9C4D-71A609153855}" })
                <!-- Retail Analytics for Global Search Box -->
                @Html.Sitecore().Rendering("{104B30A5-499C-4AF0-A670-8287E78107DD}", new {Datasource = "{A4880AAD-8BD5-4BA5-BE4E-1BBB7CF0B082}"})
                <!-- Retail Global Search Box -->
                <div id="HeaderExternalComponentSection" class="CoveoExternalComponentSection" data-search-interface-id="RetailSearchInterface">
                    <!--98A8F8F4-3100-4F58-8B0D-F03A341028C9 ID Custom search box -->
                    @Html.Sitecore().Rendering("{98A8F8F4-3100-4F58-8B0D-F03A341028C9}", new { DataSource = "{C002F534-6FDF-4048-AADC-120F22CC353D}" })
                </div>
                <script type="text/javascript">
                    document.addEventListener("DOMContentLoaded", function() {
                        var externalComponentsSection = document.getElementById("HeaderExternalComponentSection");
                        @if (Html.Coveo().IsEditingInPageEditor()) {
                            @: CoveoForSitecore.initExternalComponentsSectionForExperienceEditor(externalComponentsSection);
                        } else {
                            @: CoveoForSitecore.initExternalComponentsSection(externalComponentsSection);
                        }
                    });
                </script>
            </div>
        </header>
        <!-- END NOINDEX -->
        <main role="main">
            @Html.Sitecore().Placeholder("page-layout")
        </main>
        <!-- BEGIN NOINDEX -->
        <footer>
            @Html.Sitecore().Placeholder("footer")
        </footer>

        @Html.Sitecore().Placeholder("page-sidebar")
        <!-- END NOINDEX -->
    </div>
    @RenderAssetsService.Current.RenderScript(ScriptLocation.Body)

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var coveoForSitecoreContext = document.querySelector('.CoveoForSitecoreContext');
            var isUserAnonymous = true;
            if (coveoForSitecoreContext && coveoForSitecoreContext.dataset) {
                isUserAnonymous = coveoForSitecoreContext.dataset.scIsUserAnonymous === "true";
            }

            if (!isUserAnonymous) {
                var email = document.querySelector('#personalInfoPanel dd:nth-child(2)');

                if (email && email.textContent) {
                    email = email.textContent.trim();

                    var contactLinkElement = document.querySelector('a[href="https://retail-coveodemo-developer-edition.na59.force.com/"]');
                    if (contactLinkElement) {
                      contactLinkElement.href = contactLinkElement.href + '#' + email;
                    }
                } else {
                    email = null;
                }

                var userName = document.querySelector('#personalInfoPanel h4');

                if (userName && userName.textContent) {
                    userName = userName.textContent.trim();

                    if (userName.textContent === "You are anonymous") {
                        userName = null;
                    } else if (userName === "You are known") {
                        if (email) {
                            userName = email;
                        }
                    }
                }

                if (userName) {
                    document.querySelector('a[href="/AccountManagement"]').textContent = userName;
                }
            }
        });
    </script>
    <script src="//s3.amazonaws.com/static.coveodemo.com/demos/impact2018-habitat.js"></script>
</body>
</html>